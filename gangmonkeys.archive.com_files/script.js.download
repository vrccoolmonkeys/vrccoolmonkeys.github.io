document.addEventListener("DOMContentLoaded", function () {

    const gangListContainer = document.getElementById("gangList");
    const userListContainer = document.getElementById("userList");
    const searchInput = document.getElementById("search-input");
    const volumeSlider = document.getElementById("volume-slider");
    const video = document.getElementById("bgVideo");
    const overlay = document.getElementById("overlay");
    const audioElements = document.querySelectorAll("audio");

    let allUsers = [];
    let allGangs = [];

    /* ---------------- Overlay ---------------- */

    if (overlay) {
        document.body.classList.add("no-scroll");
        overlay.style.display = "flex";

        overlay.addEventListener("click", () => {
            overlay.classList.add("hidden");
            document.body.classList.remove("no-scroll");

            audioElements.forEach(audio => {
                audio.play().catch(() => {});
            });

            setTimeout(() => {
                overlay.style.display = "none";
            }, 500);
        });
    }

    /* ---------------- Clock ---------------- */

    const clockElement = document.getElementById("clock");
    const timeCheckPopup = document.getElementById("timeCheckPopup");

    function updateClock() {
        if (!clockElement) return;

        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        clockElement.textContent =
            `${hours}:${minutes < 10 ? "0" : ""}${minutes}`;

        if (timeCheckPopup) {
            timeCheckPopup.style.display =
                (hours === 1 || hours === 2) ? "block" : "none";
        }
    }

    setInterval(updateClock, 1000);
    updateClock();

    /* ---------------- Helpers ---------------- */

    function sanitizeText(text) {
        return text.replace(/\(Rainbow\)|\(Border\)|\(Glow\)/gi, "").trim();
    }

    function renderUsers(usernames) {
        if (!userListContainer) return;

        userListContainer.innerHTML = "";

        usernames.forEach((username, index) => {

            const card = document.createElement("div");
            card.classList.add("kcard");
            card.style.animationDelay = `${index * 0.01}s`;

            const cleanName = sanitizeText(username);
            const lower = username.toLowerCase();

            const isRainbow = lower.includes("(rainbow)");
            const isGlow = lower.includes("(glow)");
            const hasBorder = lower.includes("(border)");

            let content = cleanName;

            if (isRainbow) content = `<span class="rgb-effect">${content}</span>`;
            if (isGlow) content = `<span class="gold-effect">${content}</span>`;

            card.innerHTML = `<div class="kcard-body"><p>${content}</p></div>`;

            if (isGlow) card.classList.add("glow");
            if (hasBorder) card.classList.add("block");

            userListContainer.appendChild(card);
        });
    }

    function renderGangs(gangs) {
        if (!gangListContainer) return;

        gangListContainer.innerHTML = "";

        gangs.forEach((gang, index) => {

            const card = document.createElement("div");
            card.classList.add("kcard");
            card.style.animationDelay = `${index * 0.01}s`;

            const cleanName = sanitizeText(gang);
            const lower = gang.toLowerCase();

            const isRainbow = lower.includes("(rainbow)");
            const isGlow = lower.includes("(glow)");
            const hasBorder = lower.includes("(border)");

            let content = cleanName;

            if (isRainbow) content = `<span class="rgb-effect">${content}</span>`;
            if (isGlow) content = `<span class="glow-effect">${content}</span>`;

            card.innerHTML = `<div class="kcard-body"><p>${content}</p></div>`;

            if (isGlow) card.classList.add("glow");
            if (hasBorder) card.classList.add("block");

            gangListContainer.appendChild(card);
        });
    }

    /* ---------------- Load Files ---------------- */

    function loadUsers() {
        fetch("Users.wtf")
            .then(res => res.text())
            .then(data => {
                allUsers = data.split("\n").map(x => x.trim()).filter(Boolean);
                renderUsers(allUsers);
            })
            .catch(err => console.error("Users.wtf error:", err));
    }

    function loadGangs() {
        fetch("Gangs.wtf")
            .then(res => res.text())
            .then(data => {
                allGangs = data.split("\n").map(x => x.trim()).filter(Boolean);
                renderGangs(allGangs);
            })
            .catch(err => console.error("Gangs.wtf error:", err));
    }

    loadUsers();
    loadGangs();

    /* ---------------- Search ---------------- */

    if (searchInput) {
        searchInput.addEventListener("input", () => {
            const term = searchInput.value.toLowerCase();
            renderUsers(allUsers.filter(u => u.toLowerCase().includes(term)));
            renderGangs(allGangs.filter(g => g.toLowerCase().includes(term)));
        });
    }

    /* ---------------- Volume ---------------- */

    function saveVolume(volume) {
        localStorage.setItem("audioVolume", volume);
    }

    function getVolume() {
        return parseFloat(localStorage.getItem("audioVolume")) || 0.5;
    }

    function setVolume(volume) {
        audioElements.forEach(a => a.volume = volume);
    }

    if (volumeSlider) {
        const saved = getVolume();
        volumeSlider.value = saved;
        setVolume(saved);

        volumeSlider.addEventListener("input", () => {
            const vol = parseFloat(volumeSlider.value);
            setVolume(vol);
            saveVolume(vol);
        });
    }

    /* ---------------- Disable Right Click on Video ---------------- */

    if (video) {
        video.addEventListener("contextmenu", e => e.preventDefault());
    }

});
